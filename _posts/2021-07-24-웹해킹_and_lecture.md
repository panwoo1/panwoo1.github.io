---
title: "[모각코]해킹맛보기(웹해킹 마무리)&WebHaking(8강)"
excerpt_separator: "<!--more-->"
toc: true
toc_sticky: true
categories:
  - 모각코
tags:
  - 모각코
  - Hacking
---

## 데이터베이스 해킹

- 웹 언어별 일반적 DBMS 선택

  | 웹 언어 |  DBMS  |        공통 특징         |
  | :-----: | :----: | :----------------------: |
  |   PHP   | MySQL  |         오픈소스         |
  |   JSP   | Oracle |     오라클 사의 제품     |
  |   ASP   | MS-SQL | 마이크로소프트 사의 제품 |

### 공격에 필요한 구문

SQL Injection을 위해서는 각 DBMS 구문에 대해 알아야 함

간단한 SQL 삽입 - "SELECT {칼럼} FROM {테이블} WHERE {조건}"

- 웹 페이지의 회원 기능을 제작하기 위해 쓰이는 구문

  - 회원 가입 - INSERT문
  - 회원정보 수정 - UPDATE문
  - 로그인 - SELECT문
  - 회원 탈퇴 - DELETE문

- 로그인 쿼리

```
#쿼리는 아래와 같이 작성될 수 있음
select idx from member where id='입력아이디' and password='입력패스워드'
- Member 테이블에서 id가 '입력아이디'이고 password가 '입력패스워드'인 결과의 idx 칼럼 출력
```

- 이용자 추가

```
insert into member(id, password, name) values('입력아이디', '입력패스워드', '입력이름');
- Member 테이블에 '입력아이디', '입력패스워드', '입력이름' 값을 추가
```

- 회원정보 수정

```
update member set password='새로운 패스워드' where id='hellsonic'
- Member 테이블에 id가 hellsonic 인 경우 패스워드를 '새로운 패스워드'로 변경
```

- 회원 탈퇴

```
delete from member where id='hellsonic'
- Member 테이블에 id가 hellsonic인 경우 Row를 삭제
```

### 공격

사용자의 입력값은 대개 WHERE 조건절에 들어가게 되므로 Integer 형식이라면  
''값 없이 그냥 입력되지만, String 형식인 경우 '나 "사이에 문자열 값이 들어가게 되므로  
문자열 입력값에 삽입해 쿼리를 새로 작성할 수 있음

```
SELECT id FROM member WHERE id='admin' and password='' or '1'='1'
```

다음과 같은 쿼리를 삽입할 경우 모든 Row가 리턴되며 admin 아이디로 로그인 됨

![mysql 삽입 cheat sheet (2)](https://user-images.githubusercontent.com/66258691/126854980-f778c9c7-7954-48fb-a09a-c17d097a4a4b.jpg){: width="50%" height=50%"}

- **Blind SQL**

쿼리 결과의 참/거짓 정보만으로 데이터를 추출해내는 기법

"ABC" 에서 A를 추출해 내기 위해서 다음과 같은 과정 필요
A를 10진수로 변환, 그 값을 2진수로 변환 후 lpad 함수를 통해 8바이트로 맞춤
따라서 A라는 한 바이트의 문자열을 뽑기 위해서는 여덟 번의 쿼리가 실행되어야 함

```
select substr(lpad(bin(ord(substr("ABC",1,1))), 8, 0),1 ,1);
select substr(lpad(bin(ord(substr("ABC",1,1))), 8, 0),2 ,1);
select substr(lpad(bin(ord(substr("ABC",1,1))), 8, 0),3 ,1);
...
select substr(lpad(bin(ord(substr("ABC",1,1))), 8, 0),8 ,1);
01000001 -> "A"
```

하지만 이러한 과정은 매우 비효율적이므로 간단한 코딩을 통해 빠르게 데이터 추출 가능

- 코드 자동화

```js
j = 1;
stack = "";
while(1)
{
  for(i=1;i<=8;i++){
    result = get("http://x.x.x.x/target.php?id=1234&password=1' or (select substr(lpad(bin(ord(substr(password,j,1))),8,0) from member where id='admin')=1%23");
    if(result == Success){
      stack += "1";
    } else {
      stack += "0";
    }
  }
  print char(bindec(stack));
  stack = "";
  j++;
}
```

- 자동화 툴

  - pangolin
  - sqlmap
  - Havji

### 방어 기법

PHP의 경우 `magic_quotes_gpc` 라는 옵션을 통해 `' " \ null` 문자를 문자열 처리 함으로써  
SQL 삽입 공격 방어

---

## Sever-side Advanced - File Vulnerability

### 리눅스 파일 시스템

웹 서버는 Unix 계열의 운영체제가 많이 사용되며, 그중 상당수가 Linux 운영체제 사용

Linux 디렉터리

- **로그 및 데이터**

|                 디렉터리                  |                                        설명                                        |
| :---------------------------------------: | :--------------------------------------------------------------------------------: |
|                `/var/www`                 |                   웹 문서 및 기타 웹 서버에서 사용되는 파일 저장                   |
|                `/var/lib`                 |                   시스템의 각종 서비스에서 자료를 저장할 때 사용                   |
|             `/var/lib/mysql`              |                         MySQL 데이터베이스의 데이터가 저장                         |
| `/var/lib/pgsql 또는 /var/lib/postgresql` |                      PostgreSQL 데이터베이스의 데이터가 저장                       |
|                `/var/log`                 |                      시스템 서비스 등의 로그를 저장할 때 사용                      |
|               `/var/cache`                |                                 캐시 데이터를 저장                                 |
|                  `media`                  | 제거 가능한 매체(USB 플래시 메모리, 기타 이동 저장장치 등)를 마운트할 떄 주로 사용 |
|                  `/mnt`                   |                기타 파일시스템을 임시로 마운트하는 용도로 주로 사용                |

- **설정 파일**

|            디렉터리            |                                     설명                                     |
| :----------------------------: | :--------------------------------------------------------------------------: |
|             `/etc`             | 운영체제 초기 부팅 시 필요한 최소한의 명령어를 구현하는 프로그램 파일을 저장 |
| `/etc/apache2 또는 /etc/httpd` |                     Apache Web Server의 설정 정보를 저장                     |
|          `/etc/nginx`          |                       Nginx 웹 서버의 설정 정보를 저장                       |
|          `/etc/mysql`          |                  MySQL 데이터베이스 서버의 설정 정보를 저장                  |
|           `/opt/etc`           |                추가적으로 설치된 프로그램의 설정 정보를 저장                 |
|              파일              |                                     설명                                     |
|      `/etc/mysql/my.cnf`       |                    MySQL 데이터베이스 서버의 주 설정파일                     |
|   `/etc/passwd, /etc/group`    |                          사용자 및 그룹 정보를 저장                          |
|  `/etc/shadow, /etc/gshadow`   |               사용자 및 그룹의 인증 비밀번호를 암호화하여 저장               |
|        `/etc/hostname`         |                       현재 시스템의 호스트네임을 저장                        |
|          `/etc/hosts`          |             호스트네임의 실주소를 탐색할 때 사용되는 정적 순람표             |
|          `/etc/fstab`          |                현재 시스템에 등록할 파일시스템의 목록을 저장                 |

- **프로그램 및 라이브러리**

|                 디렉터리                 |                                     설명                                     |
| :--------------------------------------: | :--------------------------------------------------------------------------: |
|              `/bin, /sbin`               | 운영체제 초기 부팅 시 필요한 최소한의 명령어를 구현하는 프로그램 파일을 저장 |
|                 `/boot`                  |             커널이나 부트로더 옵션 등 부팅에 필요한 파일을 저장              |
|       `/lib, /lib64, /libx32, ...`       |         운영체제 초기 부팅 시 필요한 최소한의 라이브러리 파일을 저장         |
|                  `/opt`                  |                           추가적인 프로그램을 저장                           |
|                `/usr/bin`                |                     각종 명령어 및 프로그램 파일을 저장                      |
|               `/usr/sbin`                |      시스템 관리자가 주로 사용하는 각종 명령어 및 프로그램 파일을 저장       |
| `/usr/lib, /usr/lib64, /usr/libx32, ...` |                  시스템에서 공유되는 라이브러리 파일을 저장                  |
|               `/usr/share`               |                     기타 시스템에서 공유되는 파일을 저장                     |

- **장치 및 가상파일**

|                          디렉터리                           |                                           설명                                            |
| :---------------------------------------------------------: | :---------------------------------------------------------------------------------------: |
|                           `/dev `                           |                              각종 디스크 및 장치 파일을 제공                              |
|                           `/sys`                            |                          하드웨어(주변기기 등) 및 플랫폼에 접근                           |
|                           `/proc`                           |                    프로세스 및 시스템 정보를 제공하는 가상 파일시스템                     |
|                          /proc/sys                          |                   운영체제의 동작을 제어할 수 있는 각종 파라미터가 위치                   |
|              `/proc/self/net (또는 /proc/net)`              |                        운영체제 네트워크 계층의 다양한 정보를 제공                        |
|                            파일                             |                                           설명                                            |
| `/dev/null, /dev/zero, /dev/full /dev/random, /dev/urandom` |              실제 물리적인 장치를 나타내지는 않지만 자주 사용되는 특수 파일               |
|                         `/dev/pts`                          |                   유사터미널(pseudoterminal) TTY 장치가 위치한 디렉터리                   |
|               `/dev/stdin → /proc/self/fd/0`                |   파일 디스크립터 0, 즉 표준 입력(standard input)에 사용된 파일을 나타내는 심볼릭 링크    |
|               `/dev/stdout → /proc/self/fd/1`               |   파일 디스크립터 1, 즉 표준 출력(standard output)에 사용된 파일을 나타내는 심볼릭 링크   |
|               `/dev/stderr → /proc/self/fd/2`               | 파일 디스크립터 2, 즉 표준 오류 출력(standard error)에 사용된 파일을 나타내는 심볼릭 링크 |

- **임시 파일**

|       디렉터리        |                              설명                              |
| :-------------------: | :------------------------------------------------------------: |
|        `/tmp`         |       임시 파일을 저장(재시작(재부팅)시 삭제 될 수 있음)       |
|      `/var/tmp`       |     임시 파일을 저장(재시작(재부팅)시에도 일반적으로 유지)     |
|    `un (/var/run)`    | 부팅 후 생성된 각종 런타임 데이터 및 IPC 소켓 등이 이곳에 위치 |
| `/var/run/postgresql` |                   PostgreSQL 소켓 등이 위치                    |
|   `/var/run/mysql`    |                      MySQL 소켓 등이 위치                      |
|      `/dev/shm`       |          Linux shm_open(3) C 라이브러리 함수에서 사용          |

#### 파일 업로드 시 공격 지점

시스템 관리자가 웹 서비스와 같은 계정으로 로그인 하면 코드 실행 등의 공격이 가능함

- **Apache Web Server**

  - `AllowOverride` 나 `AllowOverrideList` 디렉티브로 허용할 경우 추가적으로 설정 파일로 입력 받을 수 있음
  - `htaccess` 파일이 허용되는 경우 이를 작성하여 웹 문서 디렉터리에 업로드 하면 `.php` 확장자를 우회하여  
    웹쉘을 실행하거나 문서를 접근할 때 공격자의 웹 페이지가 접속되는 등의 영향을 미침

- **/proc(일반 권한)**

  - `/proc/<PID>/` 대신 `proc/self/` 를 사용하면 현재 프로세스를 접근할 수 있음

- **설정 파일**

  - 웹 문서 설정, 쉘 명령어, SSH 공개키 지정 등

- **루트 권한**
  - 시스템 부팅 시 실행될 명령, 사용자 로그인 마다 실행되는 명령 지정 등

#### 파일 다운로드 시 공격 지점

- **시스템 가상 파일**
  - 시스템 CPU정보, 구동 시간, 커널 버전 정보 등 조회
- **설정 파일**
  - 사용자가 입력한 쉘 명령어 저장, SSH 비밀키 위치 등
- **로그 파일**
  - 사용자 접속 기록 등을 저장하는 로그 파일

### 윈도우 파일시스템

Linux와 다르게 경로에서 드라이브 지정 가능, 대부분의 중요한 파일은 `C:`에 위치한 경우가 많음

- **로그 파일**

|                   디렉터리                   |                              설명                              |
| :------------------------------------------: | :------------------------------------------------------------: |
|                 `C:\inetpub`                 | IIS서비스에서 웹 문서 및 기타 웹 서버에서 사용되는 파일을 저장 |
|             `C:\inetpub\wwwroot`             |               IIS의 웹 문서가 저장되는 기본 경로               |
|         `C:\ApacheXY\htdocs, C:\www`         |    Apache Web Server에서 문서 경로로 흔히 사용되는 디렉터리    |
|              `C:\Program Files`              |            각종 프로그램 및 데이터를 저장할 때 사용            |
|               `C:\ProgramData`               |         시스템의 각종 서비스에서 자료를 저장할 때 사용         |
| `C:\ProgramData\MySQL\MySQL Server X.Y\Data` |                  MySQL 데이터베이스의 데이터                   |
|    `C:\Program Files\PostgreSQL\X.Y\dat`     |                PostgreSQL 데이터베이스의 데이터                |
|      `C:\Windows\System32\Winevt\Logs`       |               윈도 이벤트 로그를 저장할 때 사용                |
|            `C:\Windows\Prefetch`             |                    Superfetch 데이터를 저장                    |

- **설정 파일**

|                                    디렉터리                                    |                                          설명                                          |
| :----------------------------------------------------------------------------: | :------------------------------------------------------------------------------------: |
|                          `C:\Windows\System32\config`                          |                       시스템 단위 레지스트리 하이브 파일이 저장                        |
|                                   `C:\Boot`                                    |                                 부팅 관련 파일을 저장                                  |
|                          `%UserProfile%\Ntuser.dat `                           |            %UserProfile% 프로필 디렉터리를 가진 사용자의 레지스트리가 저장             |
| `%UserProfile%\Local Settings\Application Data\Microsoft\Windows\UsrClass.dat` | %UserProfile% 프로필 디렉터리를 가진 사용자의 확장자 연결 정보 및 COM 클래스 등이 저장 |
|                            `C:\Windows\drivers\etc`                            |                 hosts, services 와 같은 네트워크 관련 설정 파일을 저장                 |
|        `C:\Program Files\Apache Software Foundation\Apache<버전>\conf`         |                          Apache Web Server의 설정 정보를 저장                          |
|                                      파일                                      |                                          설명                                          |
|                                 `C:\Boot\BCD`                                  |                          Boot Configuration Data 파일이 위치                           |
|                 `C:\ProgramData\MySQL\MySQL Server X.Y\my.ini`                 |                         MySQL 데이터베이스 서버의 주 설정파일                          |
|                    `C:\Windows\System32\drivers\etc\hosts`                     |                  호스트네임의 실주소를 탐색할 때 사용되는 정적 순람표                  |

- **프로그램 및 라이브러리**

|       디렉터리        |                                 설명                                 |
| :-------------------: | :------------------------------------------------------------------: |
|  `C:\Program Files`   |               각종 프로그램 및 데이터를 저장할 때 사용               |
| `C:\Windows\System32` |                     시스템 파일 및 DLL들이 위치                      |
| `C:\Windows\SysWOW64` | 32비트 호환(Windows-on-Windows) 레이어상 시스템 파일 및 DLL들이 위치 |

- **장치 및 가상파일**

  |                                 디렉터리                                  |                                  설명                                   |
  | :-----------------------------------------------------------------------: | :---------------------------------------------------------------------: |
  |                                  `\\.\`                                   |                 Win32 장치 파일을 접근하는 경로의 시작                  |
  |                                  `\\?\`                                   | NT 객체 관리자 하위체계의 객체 및 심볼릭 링크 등을 접근하는 경로의 시작 |
  |                             `\\?\GLOBALROOT\`                             |            실제 Object Manager의 최상위 경로를 접근하는 경로            |
  |                          `\\?\GLOBALROOT\Device`                          |                    NT 장치 객체를 포함하는 디렉터리                     |
  |                                  `\??\`                                   |                         `\\?\` 와 동일하게 사용                         |
  |                         `\\<호스트명>\<공유명>\`                          |           네트워크상에 공유된 자원에 접근할 수 있느 UNC 경로            |
  |                                 장치 파일                                 |                                  설명                                   |
  | `NUL, CON, AUX, PRN, COM1, COM2, COM3, COM4, LPT1, LPT2, LPT3, LPT4, ...` |                   예약된(reserved) DOS 기본 장치 이름                   |
  |                              `CON (\\.\CON)`                              |                             현재 콘솔 장치                              |
  |                           `CONIN$ (\\.\CONIN$)`                           |                           현재 콘솔 입력 장치                           |
  |                          `CONOUT$ (\\.\CONOUT$)`                          |                           현재 콘솔 출력 장치                           |
  |               `\\?\GLOBALROOT\Device\HarddiskVolume<N> ...`               |         다른 드라이브를 선택할 때 `C:\` 와 같은 문법 대신 사용          |

- **임시 파일**

|            디렉터리             |                     설명                      |
| :-----------------------------: | :-------------------------------------------: |
|        `C:\Windows\Temp`        |               임시 파일을 저장                |
| `%UserProfile%\AppData\Local\T` | 일반적으로 사용자별 임시 파일이 저장되는 경로 |

#### 파일 업로드 시 공격 지점

- **Apache Web Server**

  - `AllowOverride` 나 `AllowOverrideList` 디렉티브로 허용할 경우 추가적으로 설정 파일로 입력 받을 수 있음
  - `htaccess` 파일이 허용되는 경우 이를 작성하여 웹 문서 디렉터리에 업로드 하면 `.php` 확장자를 우회하여  
    웹쉘을 실행하거나 문서를 접근할 때 공격자의 웹 페이지가 접속되는 등의 영향을 미침

- **시스템 파일**

  - 관리자 권한에서 접근 가능한 시스템 파일

- **사용자 설정 파일**

  - 사용자 권한에서 접근 가능한 파일

### 파일명 검증 부재

파일 경로에서 디렉터리 명은 `/` 또는 `\`로 구분지으며, 현재 디렉토리는 `.`로, 상위 디렉터리는 `..`로 나타냄  
이처럼 다양한 소프트웨어에서는 파일 경로에서 일부 문자에 특수한 의미를 부여함
이러한 특수한 의미를 지닌 문자를 제대로 여과하지 않고 파일시스템에 사용하게 되면 취약점 발생

- **파일명 널(NULL) 문자 삽입**

운영체제에서 NULL 문자가 삽입되면 이는 파일명의 끝으로 인식됨

만약 웹 응용에서 NULL 문자를 불허하지 않으면서 파일명의 끝으로 확장자 등을 검사하면,  
확장자 뒤에 NULL 문자를 삽입함으로써 검사를 우회할 수 있음

이를 방어하기 위해 Apache 등의 웹 서버는 NULL 문자를 `400 Bad Request` 응답과 함께 거부하며,  
Python 및 PHP 등 언어의 내장 라이브러리 함수들은 파일명에 NULL문자가 있는지 검사함

- **Path Traversal**

`.` 이나 `..`와 같은 특수문자를 웹 응용에서 경로를 탐지하지 못한다면 공격자는  
상위 경로에 파일을 생성할 수 있게됨

추가적으로 윈도우에서는 `foo\bar\..\baz`와 같은 구문에서 `bar`가 실제 존재하지 않아도  
`foo/baz`로 해석해서 운영체제 간 응용을 포팅하는 도중 취약점 발생 가능

- **잘못된 확장자 검사**

  - 정규식(`$`은 줄의 끝을 의미)

    - `(\..*)`
    - `.`문자 뒤에 있는 모든 부분문자열 매칭  
      `.jpg.php`확장자를 입력하면 `.php`를 분리하지 못해 여과에 실패

    - `(\/[^.]*)`

      - `.`문자 뒤에 있는 모든 부분문자열 매칭하지만 또다른 `.` 문자가 나오면 그 부분부터는 제외
      - `.jpg.php` 확장자를 입력하면 `.jpg`만 인식하여 여과 실패

    - `(\.[^.]*)$`

      - 가장 마지막에 등장하는 `.`문자 뒤에 있는 모든 부분을 매칭
      - 만일 서버가 두 개 이상의 확장자를 인식하면 여과에 실패

    - `[^.](\.[^.]*)$`
      - 가장 마지막에 등장하는 `.` 문자 뒤에 있는 부분을 매칭하나, 시작부분의 `.` 무시
      - 서버가 확장자만 있는 파일명 자체를 확장자로 인식하면 여과 실패

- **파일명 문자열 치환 우회**

  대부분의 웹 서버는 확장자명으로 파일 종류를 판별하는데, 파일명 여과가 특정 부분문자열만  
   치환하거나 제거하는 방식으로 이루어지면, 공격자는 또다른 치환되는 문자열을 넣는 방식으로 우회할 수 있음

  - `.php`를 제거 여과 예시
    | 원본 | 치환 과정 | 결과 |
    | :---: | :---: | :---: |
    | file.jpg | file.jpg(유지) | file.jpg |
    | webshell.php | webshell ~~.php~~ | webshell |
    | webshell.ph.phpp | webshell.ph ~~.php~~ p| webshell.php |

### 응용

#### 파일 삭제 공격

대다수의 웹 응용에서는 `config.php` 와 같은 스크립트 파일로 설정 정보 관리

만일 공격자가 `config`파일을 업로드 취약점을 통해 삭제하게 된다면 셋업 페이지를 통해  
각종 설정을 변경하거나 웹 응용에 따라서 관리자 권한을 획들할 수 있음

- 참고자료
  - 해킹 맛보기
  - dreamhack WebHacking online lecture
    <https://dreamhack.io/lecture>
